@{
    ViewData["Title"] = "Giỏ hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container my-4">
    <div class="row">
        <!-- Danh sách sản phẩm -->
        <div class="col-lg-8">
            <h4 class="fw-bold mb-3">🛒 GIỎ HÀNG (<span id="itemCount">0</span> sản phẩm)</h4>
            <div class="card p-3 shadow-sm mb-3" id="cartList">
                <!-- Sản phẩm sẽ được render bằng JS -->
            </div>
        </div>

        <!-- Box thanh toán -->
        <div class="col-lg-4">
            <div class="card shadow-sm p-3">
                <h6 class="fw-bold">KHUYẾN MÃI</h6>
                <div class="bg-light p-2 mb-3 rounded">
                    <small class="text-muted">Nhập mã giảm giá ở bước thanh toán</small>
                </div>
                <h6 class="fw-bold">TỔNG CỘNG</h6>
                <div class="d-flex justify-content-between mb-2">
                    <span>Tạm tính</span>
                    <span id="subtotal">0 đ</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span><b>Tổng số tiền</b></span>
                    <span class="text-danger fw-bold" id="total">0 đ</span>
                </div>
                <button class="btn btn-danger w-100 fw-bold" onclick="checkout()">THANH TOÁN</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function updateCartCount() {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            let totalQty = cart.reduce((sum, p) => sum + p.qty, 0);
            document.getElementById("itemCount").innerText = totalQty;
            let badge = document.getElementById("cartCount");
            if (badge) badge.innerText = totalQty;
        }

        function loadCart() {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            let cartList = document.getElementById("cartList");
            cartList.innerHTML = "";
            let subtotal = 0;

            if (cart.length === 0) {
                cartList.innerHTML = `<p class="text-muted">Giỏ hàng trống</p>`;
            }

            cart.forEach((p, index) => {
                let itemTotal = p.price * p.qty;
                subtotal += itemTotal;

                let row = `
                    <div class="d-flex align-items-center border-bottom py-2">
                        <input type="checkbox" class="form-check-input me-2">
                        <img src="${p.image || '/images/Home/nhagiakim.png'}"
                             alt="${p.name}" style="width:70px; height:90px; object-fit:cover;" class="me-3">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${p.name}</h6>
                            <div class="text-danger fw-bold">${p.price.toLocaleString()} đ</div>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-outline-secondary btn-sm" onclick="changeQty(${index}, -1)">-</button>
                            <input type="number" value="${p.qty}" min="1" class="form-control mx-1"
                                   style="width:60px;" onchange="updateQty(${index}, this.value)">
                            <button class="btn btn-outline-secondary btn-sm" onclick="changeQty(${index}, 1)">+</button>
                        </div>
                        <div class="ms-3 fw-bold">${itemTotal.toLocaleString()} đ</div>
                        <button class="btn btn-link text-danger ms-3" onclick="removeItem(${index})">🗑</button>
                    </div>
                `;
                cartList.innerHTML += row;
            });

            document.getElementById("subtotal").innerText = subtotal.toLocaleString() + " đ";
            document.getElementById("total").innerText = subtotal.toLocaleString() + " đ";
            updateCartCount();
        }

        function changeQty(i, delta) {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            cart[i].qty += delta;
            if (cart[i].qty <= 0) cart[i].qty = 1;
            localStorage.setItem("cart", JSON.stringify(cart));
            loadCart();
        }

        function updateQty(i, qty) {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            qty = parseInt(qty);
            if (isNaN(qty) || qty <= 0) qty = 1;
            cart[i].qty = qty;
            localStorage.setItem("cart", JSON.stringify(cart));
            loadCart();
        }

        function removeItem(i) {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            cart.splice(i, 1);
            localStorage.setItem("cart", JSON.stringify(cart));
            loadCart();
        }

        function checkout() {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            if (cart.length === 0) {
                alert("Giỏ hàng trống!");
                return;
            }
            alert("🛒 Đặt hàng thành công!");
            localStorage.removeItem("cart");
            loadCart();
        }

        loadCart();
    </script>
}
